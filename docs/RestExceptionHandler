
======================================================================
ISFCE ‚Äì PROJET DISPENSES 25‚Äì26
DOCUMENT : EXPLICATION DE LA CLASSE RestExceptionHandler
======================================================================

L‚Äôid√©e g√©n√©rale
----------------------------------------------------------------------
Cette classe sert √† **intercepter et g√©rer les erreurs** qui se produisent dans l‚ÄôAPI REST.  
Au lieu de renvoyer des messages techniques ou illisibles (comme une ‚Äústack trace‚Äù),  
elle transforme les exceptions en **r√©ponses JSON claires et compr√©hensibles**.

C‚Äôest ce qu‚Äôon appelle un **‚Äúglobal exception handler‚Äù** (gestionnaire d‚Äôerreurs global).  
Gr√¢ce √† l‚Äôannotation `@RestControllerAdvice`, il s‚Äôapplique **√† tous les contr√¥leurs** de ton application.

----------------------------------------------------------------------
Les annotations principales
----------------------------------------------------------------------
@RestControllerAdvice  
‚Üí C‚Äôest une version combin√©e de `@ControllerAdvice` + `@ResponseBody`.  
Elle permet de capturer les exceptions lanc√©es par les contr√¥leurs REST  
et de retourner directement des **r√©ponses JSON structur√©es**.

@ExceptionHandler(...)  
‚Üí Indique quelle m√©thode doit g√©rer un type d‚Äôerreur particulier.  
Quand une exception du type indiqu√© est lev√©e quelque part dans l‚Äôapplication,  
Spring redirige automatiquement vers la m√©thode correspondante.

----------------------------------------------------------------------
Structure g√©n√©rale
----------------------------------------------------------------------
La classe contient deux m√©thodes principales :  
1Ô∏è‚É£ Une pour les erreurs de logique (IllegalStateException)  
2Ô∏è‚É£ Une pour les erreurs de validation (MethodArgumentNotValidException)

----------------------------------------------------------------------
1Ô∏è‚É£ Gestion des erreurs de logique m√©tier
----------------------------------------------------------------------
M√©thode :
```java
@ExceptionHandler(IllegalStateException.class)
public ResponseEntity<Map<String,Object>> handleIllegalState(IllegalStateException ex){
    return ResponseEntity.badRequest().body(Map.of("error", ex.getMessage()));
}
```

üéØ R√¥le :
Quand ton code l√®ve une `IllegalStateException` (par exemple dans ExemptionService ‚Üí ‚ÄúAjoute au moins un cours externe‚Äù),  
Spring intercepte cette erreur ici.

üß© Fonctionnement :
- `ResponseEntity.badRequest()` ‚Üí g√©n√®re un code HTTP **400 Bad Request**.  
- `.body(Map.of("error", ex.getMessage()))` ‚Üí cr√©e un JSON avec une cl√© `"error"`  
  et le message de l‚Äôexception.

üí° Exemple :
Si ton service fait :
```java
throw new IllegalStateException("Ajoute au moins un document.");
```
La r√©ponse HTTP sera :
```json
{
  "error": "Ajoute au moins un document."
}
```

C‚Äôest propre, lisible, et facilement exploitable par le front.

----------------------------------------------------------------------
2Ô∏è‚É£ Gestion des erreurs de validation
----------------------------------------------------------------------
M√©thode :
```java
@ExceptionHandler(MethodArgumentNotValidException.class)
public ResponseEntity<Map<String,Object>> handleValidation(MethodArgumentNotValidException ex){
    var errors = ex.getBindingResult().getFieldErrors().stream()
            .map(f -> Map.of("field", f.getField(), "message", f.getDefaultMessage()))
            .toList();
    return ResponseEntity.badRequest().body(Map.of("validationErrors", errors));
}
```

üéØ R√¥le :
Cette m√©thode s‚Äôoccupe des erreurs d√©clench√©es par la validation automatique des DTO (`@Valid`).

üß© Fonctionnement :
- `MethodArgumentNotValidException` est lev√©e quand un champ annot√© `@NotBlank`, `@Min`, etc. ne respecte pas la contrainte.
- `ex.getBindingResult().getFieldErrors()` renvoie la liste des champs invalides.
- On transforme cette liste en JSON lisible avec les cl√©s :
  - `"field"` ‚Üí le nom du champ concern√©,
  - `"message"` ‚Üí le message d‚Äôerreur par d√©faut.

üí° Exemple :
Appel POST ‚Üí `/api/requests`
```json
{ "section": "" }
```
‚Üí La validation √©choue √† cause de `@NotBlank`.

R√©ponse HTTP :
```json
{
  "validationErrors": [
    { "field": "section", "message": "must not be blank" }
  ]
}
```

üí¨ En clair :
Le contr√¥leur ne re√ßoit m√™me pas la requ√™te, Spring bloque avant  
et cette classe transforme l‚Äôerreur en un message clair pour le front.

----------------------------------------------------------------------
Les avantages de ce syst√®me
----------------------------------------------------------------------
‚úÖ Lisibilit√© : les erreurs sont compr√©hensibles c√¥t√© front (et uniformes).  
‚úÖ Simplicit√© : pas besoin de try/catch dans chaque contr√¥leur.  
‚úÖ Maintenabilit√© : si tu veux changer le format des erreurs, il suffit de modifier ici.  
‚úÖ Professionnalisme : les API REST modernes exposent toujours des erreurs structur√©es (souvent JSON).

----------------------------------------------------------------------
R√©sum√© visuel
----------------------------------------------------------------------
| Exception intercept√©e | Statut HTTP | Corps JSON de la r√©ponse |
|------------------------|-------------|---------------------------|
| IllegalStateException | 400 Bad Request | { "error": "Message d‚Äôerreur m√©tier" } |
| MethodArgumentNotValidException | 400 Bad Request | { "validationErrors": [ { "field": "...", "message": "..." } ] } |

----------------------------------------------------------------------
En r√©sum√©
----------------------------------------------------------------------
`RestExceptionHandler` est le **bouclier de s√©curit√©** de ton API :
- Il capte les exceptions non g√©r√©es dans les contr√¥leurs.
- Il renvoie des r√©ponses JSON claires, normalis√©es et utiles pour le front.
- Il centralise toute la gestion des erreurs, ce qui rend le code propre et coh√©rent.

======================================================================
FIN DU DOCUMENT ‚Äì √Ä COLLER DANS WORD ET METTRE LA POLICE √Ä 8 PT
======================================================================
